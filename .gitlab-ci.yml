image: python:3.12.1

before_script:
  - set -euxo pipefail
  - python --version
  - python -m venv venv
  - source venv/bin/activate
  - git config --global --add safe.directory "$CI_PROJECT_DIR"
  - git config --global --add safe.directory "$CI_PROJECT_DIR/neat_ml/sam2"
  - python -m pip install -U mypy ruff pandas-stubs "numpy>=1.26.3,<=2.1.3" matplotlib xgboost pandas scikit-learn openpyxl jinja2 python-ternary pytest shap interpret types-tqdm types-Pillow scikit-image lightgbm lime opencv-python-headless==4.10.0.84  pyyaml types-pyyaml pytest-mock torch
  - git submodule update --init --recursive
  - pip install -e ./neat_ml/sam2/

stages:
  - lint
  - test

lint:
  stage: lint
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: always
  allow_failure: false
  script:
    - mypy .
    - ruff check .

# a crude end-to-end test of the entire workflow
functional_test:
  stage: test
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: always
  allow_failure: false
  script:
    - python main.py

unit_tests:
  stage: test
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: always
  allow_failure: false
  script:
    - python -m pip install -v .
    - cd /tmp && python -m pytest --pyargs neat_ml
